<!DOCTYPE html>
<html lang="zh"
>
<head>
    <title>在VPS搭建VPN服务器 - Yaming Huang</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="http://yumminhuang.github.io/zai-vpsda-jian-vpnfu-wu-qi.html">

        <meta name="author" content="Yumminhuang" />
        <meta name="keywords" content="Ops,Linux" />
        <meta name="description" content="简介 从来就没有什么救世主 也不靠神仙皇帝 要创造人类的幸福 全靠我们自己 为了在 GFW 的封锁之下进行正常的上网活动，可以使用 VPN。为什么有各种各样的 VPN 服务提供商还要自己搭建 VPN 呢？有以下几方面的考虑： 安全性：你很难知道一些 VPN 提供商是否会盗取你的敏感信息，自己搭建 VPN 则可以避免这个问题； 稳定：「道高一尺，魔高一丈」，现在很多 VPN 提供商都是打一枪换一个地方，难以保证稳定的连接； 价格：自己搭建 VPN，一个月的费用大概在 $5 左右。 具体步骤 注册一个 VPS 账号 注册任意一家 VPS 服务提供商的账号。此步可能需要一张双币信用卡。 至于选择哪家服务商，此处按下不表。下文以 DigitalOcean 为例描述具体步骤。 新建一个 ..." />

        <meta property="og:site_name" content="Yaming Huang" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="在VPS搭建VPN服务器"/>
        <meta property="og:url" content="http://yumminhuang.github.io/zai-vpsda-jian-vpnfu-wu-qi.html"/>
        <meta property="og:description" content="简介 从来就没有什么救世主 也不靠神仙皇帝 要创造人类的幸福 全靠我们自己 为了在 GFW 的封锁之下进行正常的上网活动，可以使用 VPN。为什么有各种各样的 VPN 服务提供商还要自己搭建 VPN 呢？有以下几方面的考虑： 安全性：你很难知道一些 VPN 提供商是否会盗取你的敏感信息，自己搭建 VPN 则可以避免这个问题； 稳定：「道高一尺，魔高一丈」，现在很多 VPN 提供商都是打一枪换一个地方，难以保证稳定的连接； 价格：自己搭建 VPN，一个月的费用大概在 $5 左右。 具体步骤 注册一个 VPS 账号 注册任意一家 VPS 服务提供商的账号。此步可能需要一张双币信用卡。 至于选择哪家服务商，此处按下不表。下文以 DigitalOcean 为例描述具体步骤。 新建一个 ..."/>
        <meta property="article:published_time" content="2015-03-16" />
            <meta property="article:section" content="DevOps" />
            <meta property="article:tag" content="Ops" />
            <meta property="article:tag" content="Linux" />
            <meta property="article:author" content="Yumminhuang" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://yumminhuang.github.io/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="http://yumminhuang.github.io/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="http://yumminhuang.github.io/theme/css/pygments/vs.css" rel="stylesheet">
    <link rel="stylesheet" href="http://yumminhuang.github.io/theme/css/style.css" type="text/css"/>

        <link href="http://yumminhuang.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Yaming Huang ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://yumminhuang.github.io/" class="navbar-brand">
Yaming Huang            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="http://yumminhuang.github.io/pages/about-me.html">
                             About Me
                          </a></li>
                        <li class="active">
                            <a href="http://yumminhuang.github.io/category/devops.html">Devops</a>
                        </li>
                        <li >
                            <a href="http://yumminhuang.github.io/category/interview.html">Interview</a>
                        </li>
                        <li >
                            <a href="http://yumminhuang.github.io/category/objective-c.html">Objective-c</a>
                        </li>
                        <li >
                            <a href="http://yumminhuang.github.io/category/python.html">Python</a>
                        </li>
                        <li >
                            <a href="http://yumminhuang.github.io/category/shell.html">Shell</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="http://yumminhuang.github.io/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">

    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="http://yumminhuang.github.io/zai-vpsda-jian-vpnfu-wu-qi.html"
                       rel="bookmark"
                       title="Permalink to 在VPS搭建VPN服务器">
                        在VPS搭建VPN服务器
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2015-03-16T21:39:00-04:00"> Mon 16 March 2015</time>
    </span>



<span class="label label-default">Tags</span>
	<a href="http://yumminhuang.github.io/tag/ops.html">Ops</a>
        /
	<a href="http://yumminhuang.github.io/tag/linux.html">Linux</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <h2> 简介 </h2>
<blockquote>
<p> 从来就没有什么救世主 </p>
<p> 也不靠神仙皇帝 </p>
<p> 要创造人类的幸福 </p>
<p> 全靠我们自己 </p>
</blockquote>
<p> 为了在 <a href="http://zh.wikipedia.org/wiki/ 防火长城 ">GFW</a> 的封锁之下进行正常的上网活动，可以使用 <a href="http://zh.wikipedia.org/wiki/ 虛擬私人網路 ">VPN</a>。为什么有各种各样的 VPN 服务提供商还要自己搭建 VPN 呢？有以下几方面的考虑：</p>
<ol>
<li> 安全性：你很难知道一些 VPN 提供商是否会盗取你的敏感信息，自己搭建 VPN 则可以避免这个问题；</li>
<li> 稳定：「道高一尺，魔高一丈」，现在很多 VPN 提供商都是打一枪换一个地方，难以保证稳定的连接；</li>
<li> 价格：自己搭建 VPN，一个月的费用大概在 $5 左右。</li>
</ol>
<h2> 具体步骤 </h2>
<h4> 注册一个 VPS 账号 </h4>
<p> 注册任意一家 VPS 服务提供商的账号。此步可能需要一张双币信用卡。
至于选择哪家服务商，此处按下不表。下文以 <strong>DigitalOcean</strong> 为例描述具体步骤。</p>
<h4> 新建一个 Droplet</h4>
<p> 我新建的 Droplet 是最低配置，具体配置包括：</p>
<ul>
<li>512MB RAM</li>
<li>20GB SSD</li>
<li>2TB 流量 </li>
</ul>
<p> 地理位置选的是最近的。</p>
<p> 操作系统开始选择的是 Ubuntu14.04，后来用的是 Ubuntu12.04（版本应该没有影响）。</p>
<p> 没有选择多余的设置。</p>
<p> 点击新建按钮会收到一份包含登陆密码的邮件。接着就可以通过 ssh 进行登录了。</p>
<p> 其余添加用户、Linux 基本设置等内容在此不再赘述。</p>
<h4> 安装 PPTP</h4>
<div class="highlight"><pre>sudo apt-get install pptpd
</pre></div>


<h4> 配置 </h4>
<ul>
<li> 配置 IP 地址 </li>
</ul>
<p> 编辑 <code>/etc/pptpd.conf</code>，添加以下内容 ( 基本上默认设置已经完成或者被注释了 )：</p>
<div class="highlight"><pre>option /etc/ppp/pptpd-options
localip 192.168.0.1
remoteip 192.168.0.100-200
</pre></div>


<p> 这里是 PPTP 服务器的 IP 地址设为 <code>192.178.0.1</code> ，把 PPTP 客户端的 IP 地址设置为 <code>192.168.0.100</code> 到 <code>192.168.0.200</code> 的区间内。当然你也可以自己的需要和喜欢进行相应的设置 </p>
<ul>
<li> 配置客户端 DNS</li>
</ul>
<p> 编辑 <code>/etc/ppp/pptpd-options</code> ，添加 DNS 地址。这里我选择的是 <a href="https://developers.google.com/speed/public-dns/">Google Public DNS</a>。</p>
<div class="highlight"><pre>ms-dns 8.8.8.8
ms-dns 8.8.4.4
</pre></div>


<ul>
<li> 添加用户 </li>
</ul>
<p> 编辑 <code>/etc/ppp/chap-secrets</code>，添加账号和密码。其中第一列为账户名，第二列为密码。</p>
<div class="highlight"><pre># client    server  secret          IP addresses
test        pptpd   1234            *
</pre></div>


<ul>
<li> 设置 IP 转发 </li>
</ul>
<p> 打开 IPv4 转发，并重新载入设置。</p>
<div class="highlight"><pre>sudo sed -i &#39;s/#net.ipv4.ip_forward=1/net.ipv4.ip_forward=1/g&#39; /etc/sysctl.conf
sudo sysctl -p
</pre></div>


<p> 为 PPTP 连接设置 NAT，否则不能访问别的网站。</p>
<div class="highlight"><pre>iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
</pre></div>


<p> 也可以直接编辑 <code>/etc/rc.local</code>，在 <code>exit 0</code> 之前添加以上内容。</p>
<ul>
<li> 重启 PPTP</li>
</ul>
<div class="highlight"><pre>sudo service pptpd restart
</pre></div>


<p> 这样 PPTP 服务器就搭建完毕了，可以「科学上网」了！</p>
<blockquote>
<p> 没有什么能够阻挡 </p>
<p> 你对自由地向往 </p>
</blockquote>
<hr />
<h3>Trouble Shooting</h3>
<ul>
<li>PPTP connection error: GRE: Bad checksum from pppd</li>
</ul>
<p> 第一次设置完毕之后尝试连接 VPN，发现连接失败。重新设置之后依然没有解决，以至于让我怀疑是 Ubuntu14.04 的问题。我新建了一个 Droplet，更换成 Ubuntu12.04 之后还是同样的问题。接着尝试用 <code>netstat</code> 检查，发现连接已经建立，但是因为某种原因被断开了。检查 <code>/var/log/syslog</code>，发现了以下内容：</p>
<div class="highlight"><pre>Mar 21 16:54:23 Server pptpd[1808]: GRE: Bad checksum from pppd.
Mar 21 16:54:53 Server pppd[1809]: LCP: timeout sending Config-Requests
Mar 21 16:54:53 Server pppd[1809]: Connection terminated.
Mar 21 16:54:53 Server pppd[1809]: Modem hangup
Mar 21 16:54:53 Server pppd[1809]: Exit.
Mar 21 16:54:53 Server pptpd[1808]: GRE: read(fd=6,buffer=80504c0,len=8196) from PTY failed: status = -1 error = Input/output error, usually caused by unexpected termination of pppd, check option syntax and pppd logs
Mar 21 16:54:53 Server pptpd[1808]: CTRL: PTY read or GRE write failed (pty,gre)=(6,7)
Mar 21 16:54:53 Server pptpd[1808]: CTRL: Reaping child PPP[1809]
Mar 21 16:54:53 Server pptpd[1808]: CTRL: Client 50.164.202.163 control connection finished
</pre></div>


<p> 上网搜索，在 StackOverflow 上找到了 <a href="http://stackoverflow.com/a/21347817"> 答案 </a>。至此，终于定位到无法连接的根本原因 —— 是 TMD 路由器不支持 <code>PPTP Passthrough</code> 功能。我上路由器厂商的官网一看，果然发现了去年 12 月发布了一个固件更新用来修复 VPN 连接的问题。</p>
<hr />
<h3>VPS 服务提供商选择 </h3>
<ul>
<li>Amazon Web Service<ul>
<li> 大公司，服务稳定，无须担心亚马逊被封（因为亚马逊非常熟悉中国的那一套，<a href="http://zhuanlan.zhihu.com/riobard/19910423"> 有图 </a> 为证）；</li>
<li> 高度可定制；</li>
<li> 丰富的文档、社区支持；</li>
<li> 按小时收费，新注册用户可以免费使用一年；</li>
<li> 可以将虚拟机部署在东京，理论上访问速度更快。</li>
<li> 缺点：<strong> 设置复杂 </strong></li>
</ul>
</li>
<li>DigitalOcean<ul>
<li> 可选择包月套餐，性价比更高；</li>
<li> 控制台界面清爽、简洁。</li>
</ul>
</li>
<li>Linode 似乎很多人在用，一个老牌的 VPS 提供商，但是我没有用过。</li>
</ul>
<p> 如果你选择 DigitalOcean，点击 <a href="https://www.digitalocean.com/?refcode=ba81ee4b40b2"> 链接 </a> 注册，可以获得 10 美元的优惠。</p>
<hr />
<h3> 参考文献：</h3>
<ol>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-setup-your-own-vpn-with-pptp">How To Setup Your Own VPN With PPTP -- DigitalOcean.com</a></li>
<li><a href="https://riobard.com/2011/11/12/pptp-vpn-on-ubuntu/">Configure PPTP VPN on Ubuntu</a></li>
</ol>
            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">
            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="http://github.com/yumminhuang"><i class="fa fa-github-square fa-lg"></i> github</a></li>
                <li class="list-group-item"><a href="https://stackoverflow.com/users/2755574/yumminhuang"><i class="fa fa-stack-overflow fa-lg"></i> stack-overflow</a></li>
                <li class="list-group-item"><a href="http://www.linkedin.com/pub/yaming-huang/5b/932/6a0"><i class="fa fa-linkedin-square fa-lg"></i> linkedin</a></li>
                <li class="list-group-item"><a href="http://twitter.com/yumminhuang"><i class="fa fa-twitter-square fa-lg"></i> twitter</a></li>
                <li class="list-group-item"><a href="http://www.weibo.com/2622511625"><i class="fa fa-weibo fa-lg"></i> weibo</a></li>
                <li class="list-group-item"><a href="http://instagram.com/yumminhuang"><i class="fa fa-instagram fa-lg"></i> instagram</a></li>
              </ul>
            </li>



            <li class="list-group-item"><a href="http://yumminhuang.github.io/"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
                <ul class="list-group " id="tags">
                    <li class="list-group-item tag-1">
                        <a href="http://yumminhuang.github.io/tag/python.html">
                            Python
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="http://yumminhuang.github.io/tag/linux.html">
                            Linux
                        </a>
                    </li>
                    <li class="list-group-item tag-2">
                        <a href="http://yumminhuang.github.io/tag/shell.html">
                            Shell
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://yumminhuang.github.io/tag/ops.html">
                            Ops
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://yumminhuang.github.io/tag/boto.html">
                            Boto
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://yumminhuang.github.io/tag/objective-c.html">
                            Objective-C
                        </a>
                    </li>
                </ul>
            </li>

    <li class="list-group-item"><h4><i class="fa fa-github fa-lg"></i><span class="icon-label">GitHub Repos</span></h4>
        <div id="gh_repos">
            <p class="list-group-item">Status updating...</p>
        </div>
    </li>
    <li class="list-group-item"><h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="list-group-item">
            <a href="https://www.northeastern.edu/" target="_blank">
                NEU
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://www.jnu.edu.cn/" target="_blank">
                JNU
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://fionser.github.io/" target="_blank">
                Fionser's Blog
            </a>
        </li>
      </ul>
    </li>
    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2015 Yumminhuang
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>              <p><small>  <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/"><img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc/4.0/80x15.png" /></a>
    Content
  licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution 4.0 International License</a>, except where indicated otherwise.
</small></p>
         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="http://yumminhuang.github.io/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://yumminhuang.github.io/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://yumminhuang.github.io/theme/js/respond.min.js"></script>

    <!-- GitHub JS -->
    <script type="text/javascript">
        $(document).ready(function () {
            if (!window.jXHR) {
                var jxhr = document.createElement('script');
                jxhr.type = 'text/javascript';
                jxhr.src = 'http://yumminhuang.github.io/theme/js/jXHR.js';
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(jxhr, s);
            }

            github.showRepos({
                user: 'yumminhuang',
                count: 5,
                skip_forks: false,
                target: '#gh_repos'
            });
        });
    </script>
    <script src="http://yumminhuang.github.io/theme/js/github.js" type="text/javascript"></script>
    <!-- End GitHub JS Code -->

</body>
</html>