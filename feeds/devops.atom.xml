<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Yumminhuang</title><link href="http://yumminhuang.github.io/" rel="alternate"></link><link href="http://yumminhuang.github.io/feeds/devops.atom.xml" rel="self"></link><id>http://yumminhuang.github.io/</id><updated>2015-03-21T18:06:00-04:00</updated><entry><title>在VPS搭建VPN服务器</title><link href="http://yumminhuang.github.io/zai-vpsda-jian-vpnfu-wu-qi.html" rel="alternate"></link><updated>2015-03-21T18:06:00-04:00</updated><author><name>Yumminhuang</name></author><id>tag:yumminhuang.github.io,2015-03-16:zai-vpsda-jian-vpnfu-wu-qi.html</id><summary type="html">&lt;h2&gt; 简介 &lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt; 从来就没有什么救世主 &lt;/p&gt;
&lt;p&gt; 也不靠神仙皇帝 &lt;/p&gt;
&lt;p&gt; 要创造人类的幸福 &lt;/p&gt;
&lt;p&gt; 全靠我们自己 &lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt; 为了在 &lt;a href="http://zh.wikipedia.org/wiki/ 防火长城 "&gt;GFW&lt;/a&gt; 的封锁之下进行正常的上网活动，可以使用 &lt;a href="http://zh.wikipedia.org/wiki/ 虛擬私人網路 "&gt;VPN&lt;/a&gt;。为什么有各种各样的 VPN 服务提供商还要自己搭建 VPN 呢？有以下几方面的考虑：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt; 安全性：你很难知道一些 VPN 提供商是否会盗取你的敏感信息，自己搭建 VPN 则可以避免这个问题；&lt;/li&gt;
&lt;li&gt; 稳定：「道高一尺，魔高一丈」，现在很多 VPN 提供商都是打一枪换一个地方，难以保证稳定的连接；&lt;/li&gt;
&lt;li&gt; 价格：自己搭建 VPN，一个月的费用大概在 $5 左右。&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt; 具体步骤 &lt;/h2&gt;
&lt;h4&gt; 注册一个 VPS 账号 &lt;/h4&gt;
&lt;p&gt; 注册任意一家 VPS 服务提供商的账号。此步可能需要一张双币信用卡。
至于选择哪家服务商，此处按下不表。下文以 &lt;strong&gt;DigitalOcean&lt;/strong&gt; 为例描述具体步骤。&lt;/p&gt;
&lt;h4&gt; 新建一个 Droplet&lt;/h4&gt;
&lt;p&gt; 我新建的 Droplet 是最低配置，具体配置包括：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;512MB RAM&lt;/li&gt;
&lt;li&gt;20GB SSD&lt;/li&gt;
&lt;li&gt;2TB 流量 &lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt; 地理位置选的是最近的。&lt;/p&gt;
&lt;p&gt; 操作系统开始选择的是 Ubuntu14.04，后来用的是 Ubuntu12.04（版本应该没有影响）。&lt;/p&gt;
&lt;p&gt; 没有选择多余的设置。&lt;/p&gt;
&lt;p&gt; 点击新建按钮会收到一份包含登陆密码的邮件。接着就可以通过 ssh 进行登录了。&lt;/p&gt;
&lt;p&gt; 其余添加用户、Linux 基本设置等内容在此不再赘述。&lt;/p&gt;
&lt;h4&gt; 安装 PPTP&lt;/h4&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;sudo apt-get install pptpd
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt; 配置 &lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt; 配置 IP 地址 &lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt; 编辑 &lt;code&gt;/etc/pptpd.conf&lt;/code&gt;，添加以下内容 ( 基本上默认设置已经完成或者被注释了 )：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;option /etc/ppp/pptpd-options
localip 192.168.0.1
remoteip 192.168.0.100-200
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt; 这里是 PPTP 服务器的 IP 地址设为 &lt;code&gt;192.178.0.1&lt;/code&gt; ，把 PPTP 客户端的 IP 地址设置为 &lt;code&gt;192.168.0.100&lt;/code&gt; 到 &lt;code&gt;192.168.0.200&lt;/code&gt; 的区间内。当然你也可以自己的需要和喜欢进行相应的设置 &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt; 配置客户端 DNS&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt; 编辑 &lt;code&gt;/etc/ppp/pptpd-options&lt;/code&gt; ，添加 DNS 地址。这里我选择的是 &lt;a href="https://developers.google.com/speed/public-dns/"&gt;Google Public DNS&lt;/a&gt;。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;ms-dns 8.8.8.8
ms-dns 8.8.4.4
&lt;/pre&gt;&lt;/div&gt;


&lt;ul&gt;
&lt;li&gt; 添加用户 &lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt; 编辑 &lt;code&gt;/etc/ppp/chap-secrets&lt;/code&gt;，添加账号和密码。其中第一列为账户名，第二列为密码。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;# client    server  secret          IP addresses
test        pptpd   1234            *
&lt;/pre&gt;&lt;/div&gt;


&lt;ul&gt;
&lt;li&gt; 设置 IP 转发 &lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt; 打开 IPv4 转发，并重新载入设置。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;sudo sed -i &amp;#39;s/#net.ipv4.ip_forward=1/net.ipv4.ip_forward=1/g&amp;#39; /etc/sysctl.conf
sudo sysctl -p
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt; 为 PPTP 连接设置 NAT，否则不能访问别的网站。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt; 也可以直接编辑 &lt;code&gt;/etc/rc.local&lt;/code&gt;，在 &lt;code&gt;exit 0&lt;/code&gt; 之前添加以上内容。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt; 重启 PPTP&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;sudo service pptpd restart
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt; 这样 PPTP 服务器就搭建完毕了，可以「科学上网」了！&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt; 没有什么能够阻挡 &lt;/p&gt;
&lt;p&gt; 你对自由地向往 &lt;/p&gt;
&lt;/blockquote&gt;
&lt;hr /&gt;
&lt;h3&gt;Trouble Shooting&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;PPTP connection error: GRE: Bad checksum from pppd&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt; 第一次设置完毕之后尝试连接 VPN，发现连接失败。重新设置之后依然没有解决，以至于让我怀疑是 Ubuntu14.04 的问题。我新建了一个 Droplet，更换成 Ubuntu12.04 之后还是同样的问题。接着尝试用 &lt;code&gt;netstat&lt;/code&gt; 检查，发现连接已经建立，但是因为某种原因被断开了。检查 &lt;code&gt;/var/log/syslog&lt;/code&gt;，发现了以下内容：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;Mar 21 16:54:23 Server pptpd[1808]: GRE: Bad checksum from pppd.
Mar 21 16:54:53 Server pppd[1809]: LCP: timeout sending Config-Requests
Mar 21 16:54:53 Server pppd[1809]: Connection terminated.
Mar 21 16:54:53 Server pppd[1809]: Modem hangup
Mar 21 16:54:53 Server pppd[1809]: Exit.
Mar 21 16:54:53 Server pptpd[1808]: GRE: read(fd=6,buffer=80504c0,len=8196) from PTY failed: status = -1 error = Input/output error, usually caused by unexpected termination of pppd, check option syntax and pppd logs
Mar 21 16:54:53 Server pptpd[1808]: CTRL: PTY read or GRE write failed (pty,gre)=(6,7)
Mar 21 16:54:53 Server pptpd[1808]: CTRL: Reaping child PPP[1809]
Mar 21 16:54:53 Server pptpd[1808]: CTRL: Client 50.164.202.163 control connection finished
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt; 上网搜索，在 StackOverflow 上找到了 &lt;a href="http://stackoverflow.com/a/21347817"&gt; 答案 &lt;/a&gt;。至此，终于定位到无法连接的根本原因 —— 是 TMD 路由器不支持 &lt;code&gt;PPTP Passthrough&lt;/code&gt; 功能。我上路由器厂商的官网一看，果然发现了去年 12 月发布了一个固件更新用来修复 VPN 连接的问题。&lt;/p&gt;
&lt;hr /&gt;
&lt;h3&gt;VPS 服务提供商选择 &lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Amazon Web Service&lt;ul&gt;
&lt;li&gt; 大公司，服务稳定，无须担心亚马逊被封（因为亚马逊非常熟悉中国的那一套，&lt;a href="http://zhuanlan.zhihu.com/riobard/19910423"&gt; 有图 &lt;/a&gt; 为证）；&lt;/li&gt;
&lt;li&gt; 高度可定制；&lt;/li&gt;
&lt;li&gt; 丰富的文档、社区支持；&lt;/li&gt;
&lt;li&gt; 按小时收费，新注册用户可以免费使用一年；&lt;/li&gt;
&lt;li&gt; 可以将虚拟机部署在东京，理论上访问速度更快。&lt;/li&gt;
&lt;li&gt; 缺点：&lt;strong&gt; 设置复杂 &lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;DigitalOcean&lt;ul&gt;
&lt;li&gt; 可选择包月套餐，性价比更高；&lt;/li&gt;
&lt;li&gt; 控制台界面清爽、简洁。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Linode 似乎很多人在用，一个老牌的 VPS 提供商，但是我没有用过。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt; 如果你选择 DigitalOcean，点击 &lt;a href="https://www.digitalocean.com/?refcode=ba81ee4b40b2"&gt; 链接 &lt;/a&gt; 注册，可以获得 10 美元的优惠。&lt;/p&gt;
&lt;hr /&gt;
&lt;h3&gt; 参考文献：&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href="https://www.digitalocean.com/community/tutorials/how-to-setup-your-own-vpn-with-pptp"&gt;How To Setup Your Own VPN With PPTP -- DigitalOcean.com&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://riobard.com/2011/11/12/pptp-vpn-on-ubuntu/"&gt;Configure PPTP VPN on Ubuntu&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;</summary><category term="Ops"></category><category term="Linux"></category></entry></feed>